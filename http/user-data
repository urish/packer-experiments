#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  refresh-installer:
      update: yes
  keyboard:
      layout: us
  network:
      network:
          version: 2
          ethernets:
              eth0:
                 dhcp4: yes
  apt:
      primary:
          - arches: [default]
            uri: http://archive.ubuntu.com/ubuntu/
  storage:
      layout:
          name: lvm
  identity:
      realname: 'Tiny Tapeout User'
      username: ttuser
      # A password hash is needed. `mkpasswd --method=SHA-512` can help.
      # password: magic
      password: '$6$R0qxzPSbPU5Ynr$Gq2DzboPGHyQw8BmzjakviAK0fvdRS6c6V9WGmIqA5pI/bCWX782kHqGZcJs6vIbLtgVUlxLPH9zmW9eXpqej1'
      hostname: ubuntu-desktop
  ssh:
      install-server: yes
      authorized-keys: []
      allow-pw: yes
  packages:
      - ca-certificates
      - open-vm-tools
      - openssh-server
      - net-tools
      - curl
      - sudo
      - software-properties-common
      - apt-transport-https
      - lsb-release
  early-commands:
    # otherwise packer tries to connect and exceed max attempts:
    - systemctl stop ssh.service
    - systemctl stop ssh.socket
  late-commands:
      - echo 'ttuser ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ttuser
      - |
        cat > /target/etc/systemd/network/20-dhcp.network << EOF
        [Match]
        Name=enp*

        [Network]
        DHCP=ipv4
        EOF
      - |
        curtin in-target --target=/target -- /bin/bash -c ' \
            exit 0 \
        '
